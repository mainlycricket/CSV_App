package main

import (
	"encoding/json"
	"context"
	"fmt"
	"log"
	"net/http"
	"net/url"
	"slices"
	"time"
)

type ApiResponse struct {
	Success bool   `json:"success"`
	Message string `json:"message"`
	Data    any    `json:"data"`
}

func getJsonResponse(success bool, message string, data any) []byte {
	response := ApiResponse{Success: success, Message: message, Data: data}
	jsonData, err := json.Marshal(response)

	if err != nil {
		response := ApiResponse{Success: false, Message: "failed to jsonify response"}
		jsonData, _ := json.Marshal(response)
		return jsonData
	}

	return jsonData
}

func startServer() *http.Server {
	{{ range $table := . }}
		{{ if .IsAuthTable }}
		// AUTH routes
		http.HandleFunc("POST /__auth/register", api_create_ {{- .TableName -}})
		http.HandleFunc("POST /__auth/login", api_login_user)
		http.HandleFunc("GET /__auth/logout", api_logout_user)
		{{ else }}
		// {{ .TableName }} routes
		http.HandleFunc("POST /{{- .TableName -}}", api_create_ {{- .TableName -}})
		http.HandleFunc("GET /{{- .TableName -}}", api_getAll_ {{- .TableName -}})
		http.HandleFunc("GET /{{- .TableName -}}ByPK", api_getByPk_ {{- .TableName -}})
		http.HandleFunc("PUT /{{- .TableName -}}", api_update_ {{- .TableName -}})
		http.HandleFunc("DELETE /{{- .TableName -}}", api_delete_ {{- .TableName -}})
		{{ end }}
	{{ end }}

	s := &http.Server{
		Addr:           ":8080",
	}

	return s
}

{{ range $table := . }}
	{{- if .IsAuthTable -}}
	// AUTH handler functions
	{{ template "create" $table }}
	{{ template "login" $table }}
	{{ template "logout" $table }}
	{{ else }}
	// {{ .TableName }} handler functions
	{{ template "create" $table }}
	{{ template "readAll" $table }}
	{{ template "readByPK" $table }}
	{{ template "update" $table }}
	{{ template "delete" $table }}
	{{ end }}
{{ end }}

{{ define "create" }}
func api_create_ {{- .TableName -}} (w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json")

	{{ if .TableAuth.WriteAuth.BasicAuth }}
		{{- "\n\n" -}}
		{{- if len .TableAuth.WriteAuth.Priviliges -}} 
			{{- "claims" -}}
		{{- else -}}
			{{- "_" -}}
		{{- end -}}

		, err := authorizeRequest(r, {{- printf "%#v" .TableAuth.WriteAuth.AllowedRoles -}})
		if err != nil {
			w.WriteHeader(http.StatusUnauthorized)
			log.Printf("%s %s %v: %v", r.Method, r.URL.Path, http.StatusUnauthorized, err)
			w.Write(getJsonResponse(false, "unauthorized request", nil))
			return
		}
	{{ end }}

	var item Table_ {{- .TableName }}

	{{ $userField := .TableAuth.UserField }}

	{{ if len .TableAuth.WriteAuth.Priviliges }}
		role := claims["role"].(string)
	{{- end -}}

	{{ range $field, $roles := .TableAuth.WriteAuth.Priviliges }}
		if !slices.Contains({{ printf "%#v" $roles }}, role) {
			{{ if eq $field $userField }}
				claimValue, _ := claims["username"].(string)
			{{ else}}
				claimValue, _ := claims[" {{- capitalize $field -}} "].(string)
			{{ end }}
			item.Column_ {{- $field -}}.String = claimValue
		}
	{{ end }}

	if err := json.NewDecoder(r.Body).Decode(&item); err != nil {
		message := fmt.Sprintf("error while reading request body: %v", err)
		log.Print(message)
		w.WriteHeader(http.StatusBadRequest)
		w.Write(getJsonResponse(false, message, nil))
		return
	}

	{{ template "hashData" .Columns }}

	ctx := r.Context()

	if err := db_insert_ {{- .TableName -}} (ctx, &item); err != nil {
		message := fmt.Sprintf("error while creating: %v", err)
		log.Print(message)
		w.WriteHeader(http.StatusBadRequest)
		w.Write(getJsonResponse(false, message, nil))
		return
	}

	w.WriteHeader(http.StatusCreated)
	w.Write(getJsonResponse(true, "created successfully", nil))
}
{{ end }}

{{ define "readAll" }}
func api_getAll_ {{- .TableName -}} (w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json")

	{{ if .TableAuth.ReadAuth.BasicAuth }}
		{{- "\n\n" -}}
		{{- if .TableAuth.ReadAuth.Priviliges -}} 
			{{- "claims" -}}
		{{- else -}}
			{{- "_" -}}
		{{- end -}}

		, err := authorizeRequest(r, {{- printf "%#v" .TableAuth.ReadAuth.AllowedRoles -}})
		if err != nil {
			w.WriteHeader(http.StatusUnauthorized)
			log.Printf("%s %s %v: %v", r.Method, r.URL.Path, http.StatusUnauthorized, err)
			w.Write(getJsonResponse(false, "unauthorized request", nil))
			return
		}
	{{ end }}

	queryValues, err := url.ParseQuery(r.URL.RawQuery)

	{{ if len .TableAuth.WriteAuth.Priviliges }}
		role := claims["role"].(string)
	{{ end }}

	{{ $userField := .TableAuth.UserField }}

	{{ range $field, $roles := .TableAuth.WriteAuth.Priviliges }}
		if !slices.Contains({{ printf "%#v" $roles }}, role) {
			{{ if eq $field $userField }}
				claimValue, _ := claims["username"].(string)
			{{ else }}
				claimValue, _ := claims[" {{- capitalize $field -}} "].(string)
			{{ end }}
			queryValues["{{ $field }}"] = []string{claimValue}
		}
	{{ end }}

	if err != nil {
		message := fmt.Sprintf("error while parsing request query: %v", err)
		log.Print(message)
		w.WriteHeader(http.StatusBadRequest)
		w.Write(getJsonResponse(false, message, nil))
		return
	}

	var clause string
	var args []any

	if len(queryValues) > 0 {
		clause, args, err = getQueryClauseArgs(queryValues, Map_ {{- .TableName -}}, "{{- .TableName -}}")

		if err != nil {
			message := fmt.Sprintf("error while parsing request query: %v", err)
			log.Print(message)
			w.WriteHeader(http.StatusBadRequest)
			w.Write(getJsonResponse(false, message, nil))
			return
		}
	}

	ctx := r.Context()
	data, err := db_readAll_ {{- .TableName -}} (ctx, clause, args)

	if err != nil {
		message := fmt.Sprintf("error while reading: %v", err)
		log.Print(message)
		w.WriteHeader(http.StatusInternalServerError)
		w.Write(getJsonResponse(false, message, nil))
		return
	}

	w.Write(getJsonResponse(true, "data fetched successfully", data))
}
{{ end }}

{{ define "readByPK" }}
func api_getByPk_ {{- .TableName -}} (w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json")

	{{ if .TableAuth.ReadAuth.BasicAuth }}
		{{- "\n\n" -}}
		{{- if .TableAuth.ReadAuth.Priviliges -}} 
			{{- "claims" -}}
		{{- else -}}
			{{- "_" -}}
		{{- end -}}

		, err := authorizeRequest(r, {{- printf "%#v" .TableAuth.ReadAuth.AllowedRoles -}})
		if err != nil {
			w.WriteHeader(http.StatusUnauthorized)
			log.Printf("%s %s %v: %v", r.Method, r.URL.Path, http.StatusUnauthorized, err)
			w.Write(getJsonResponse(false, "unauthorized request", nil))
			return
		}
	{{ end }}

	queryValues, err := url.ParseQuery(r.URL.RawQuery)

	if err != nil {
		message := fmt.Sprintf("error while parsing request query: %v", err)
		log.Print(message)
		w.WriteHeader(http.StatusBadRequest)
		w.Write(getJsonResponse(false, message, nil))
		return
	}

	id := getPkParam(queryValues, "{{- getPkType . -}}")
	if len(id) == 0 {
		message := "missing id param in request query"
		log.Print(message)
		w.WriteHeader(http.StatusBadRequest)
		w.Write(getJsonResponse(false, message, nil))
		return
	}

	{{ if len .TableAuth.ReadAuth.Priviliges }}
		role := claims["role"].(string)
	{{ end }}

	ctx := r.Context()

	{{ $userField := .TableAuth.UserField }}

	{{ range $field, $roles := .TableAuth.ReadAuth.Priviliges }}
		if !slices.Contains({{ printf "%#v" $roles }}, role) {
			{{ if eq $field $userField }}
				claimValue, _ := claims["username"].(string)
			{{ else }}
				claimValue, _ := claims[" {{- capitalize $field -}} "].(string)
			{{ end }}
			ctx = context.WithValue(ctx, "{{ $field }}", claimValue)
		}
	{{ end }}

	data, err := db_read_ {{- .TableName -}} _ByPK (ctx, id)

	if err != nil {
		message := fmt.Sprintf("error while reading data: %v", err)
		log.Print(message)
		w.WriteHeader(http.StatusBadRequest)
		w.Write(getJsonResponse(false, message, nil))
		return
	}

	w.Write(getJsonResponse(true, "found data", data))
}
{{ end }}

{{ define "update" }}
func api_update_ {{- .TableName -}} (w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json")

	{{ if .TableAuth.WriteAuth.BasicAuth }}
		{{- "\n\n" -}}
		{{- if len .TableAuth.WriteAuth.Priviliges -}} 
			{{- "claims" -}}
		{{- else -}}
			{{- "_" -}}
		{{- end -}}

		, err := authorizeRequest(r, {{- printf "%#v" .TableAuth.WriteAuth.AllowedRoles -}})
		if err != nil {
			w.WriteHeader(http.StatusUnauthorized)
			log.Printf("%s %s %v: %v", r.Method, r.URL.Path, http.StatusUnauthorized, err)
			w.Write(getJsonResponse(false, "unauthorized request", nil))
			return
		}
	{{ end }}

	queryValues, err := url.ParseQuery(r.URL.RawQuery)

	if err != nil {
		message := fmt.Sprintf("error while parsing request query: %v", err)
		log.Print(message)
		w.WriteHeader(http.StatusBadRequest)
		w.Write(getJsonResponse(false, message, nil))
		return
	}

	id := getPkParam(queryValues, "{{- getPkType . -}}")
	if len(id) == 0 {
		message := "missing id param in request query"
		log.Print(message)
		w.WriteHeader(http.StatusBadRequest)
		w.Write(getJsonResponse(false, message, nil))
		return
	}

	var item Table_ {{- .TableName }}

	{{ if len .TableAuth.WriteAuth.Priviliges }}
		role := claims["role"].(string)
	{{ end }}

	ctx := r.Context()

	{{ $userField := .TableAuth.UserField }}

	{{ range $field, $roles := .TableAuth.WriteAuth.Priviliges }}
		if !slices.Contains({{ printf "%#v" $roles }}, role) {
			{{ if eq $field $userField }}
				claimValue, _ := claims["username"].(string)
			{{ else }}
				claimValue, _ := claims[" {{- capitalize $field -}} "].(string)
			{{ end }}
			ctx = context.WithValue(ctx, "{{ $field }}", claimValue)
			item.Column_ {{- $field -}}.String = claimValue
		}
	{{ end }}

	if err := json.NewDecoder(r.Body).Decode(&item); err != nil {
		message := fmt.Sprintf("error while reading request body: %v", err)
		log.Print(message)
		w.WriteHeader(http.StatusBadRequest)
		w.Write(getJsonResponse(false, message, nil))
		return
	}

	{{ template "hashData" .Columns }}

	if err := db_update_ {{- .TableName -}} (ctx, id, &item); err != nil {
		message := fmt.Sprintf("error while updating : %v", err)
		log.Print(message)
		w.WriteHeader(http.StatusBadRequest)
		w.Write(getJsonResponse(false, message, nil))
		return
	}

	w.Write(getJsonResponse(true, "updated successfully", nil))
}
{{ end }}

{{ define "delete" }}
func api_delete_ {{- .TableName -}} (w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json")

	{{ if .TableAuth.WriteAuth.BasicAuth }}
		{{- "\n\n" -}}
		{{- if len .TableAuth.WriteAuth.Priviliges -}} 
			{{- "claims" -}}
		{{- else -}}
			{{- "_" -}}
		{{- end -}}

		, err := authorizeRequest(r, {{- printf "%#v" .TableAuth.WriteAuth.AllowedRoles -}})
		if err != nil {
			w.WriteHeader(http.StatusUnauthorized)
			log.Printf("%s %s %v: %v", r.Method, r.URL.Path, http.StatusUnauthorized, err)
			w.Write(getJsonResponse(false, "unauthorized request", nil))
			return
		}
	{{ end }}

	queryValues, err := url.ParseQuery(r.URL.RawQuery)

	if err != nil {
		message := fmt.Sprintf("error while parsing request query: %v", err)
		log.Print(message)
		w.WriteHeader(http.StatusBadRequest)
		w.Write(getJsonResponse(false, message, nil))
		return
	}

	id := getPkParam(queryValues, "{{- getPkType . -}}")
	if len(id) == 0 {
		message := "missing id param in request query"
		log.Print(message)
		w.WriteHeader(http.StatusBadRequest)
		w.Write(getJsonResponse(false, message, nil))
		return
	}

	{{ if len .TableAuth.WriteAuth.Priviliges }}
		role := claims["role"].(string)
	{{ end }}

	ctx := r.Context()

	{{ $userField := .TableAuth.UserField }}

	{{ range $field, $roles := .TableAuth.WriteAuth.Priviliges }}
		if !slices.Contains({{ printf "%#v" $roles }}, role) {
			{{ if eq $field $userField }}
				claimValue, _ := claims["username"].(string)
			{{ else }}
				claimValue, _ := claims[" {{- capitalize $field -}} "].(string)
			{{ end }}
			ctx = context.WithValue(ctx, "{{ $field }}", claimValue)
		}
	{{ end }}

	if err := db_delete_ {{- .TableName -}} (ctx, id); err != nil {
		message := fmt.Sprintf("error while deleting: %v", err)
		log.Print(message)
		w.WriteHeader(http.StatusBadRequest)
		w.Write(getJsonResponse(false, message, nil))
		return
	}

	w.Write(getJsonResponse(true, "deleted successfully", nil))
}
{{ end }}

{{- define "login" }}
func api_login_user(w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json")

	var credentials Login_Input

	if err := json.NewDecoder(r.Body).Decode(&credentials); err != nil {
		message := fmt.Sprintf("error while reading request body: %v", err)
		log.Print(message)
		w.WriteHeader(http.StatusBadRequest)
		w.Write(getJsonResponse(false, message, nil))
		return
	}

	ctx := r.Context()

	user, err := db_auth_login(ctx, &credentials)

	if err != nil {
		message := fmt.Sprintf("error while logging in: %v", err)
		log.Print(message)
		w.WriteHeader(http.StatusUnauthorized)
		w.Write(getJsonResponse(false, "login failed!", nil))
		return
	}

	if err := comparePassword(credentials.Password, user.Password); err != nil {
		message := fmt.Sprintf("error while logging in: %v", err)
		log.Print(message)
		w.WriteHeader(http.StatusUnauthorized)
		w.Write(getJsonResponse(false, "login failed!", nil))
		return
	}

	token, err := getSignedToken(user.Username
	
	{{- range $column := .Columns -}}
		{{- if eq $column.ColumnName "role" -}}
			, user.Role
			{{- break -}}
		{{- end -}}
	{{- end -}}

	{{- range $field := getOrgFields -}}
		, user. {{- capitalize $field -}} 
	{{- end -}}
	)

	if err != nil {
		message := fmt.Sprintf("error while logging in: %v", err)
		log.Print(message)
		w.WriteHeader(http.StatusUnauthorized)
		w.Write(getJsonResponse(false, "login failed!", nil))
		return
	}

	cookie := &http.Cookie{
		Name:     "access_token",
		Value:    token,
		Expires:  time.Now().Add(30 * 24 * time.Hour), // expires in 30 days
		HttpOnly: true,
		SameSite: http.SameSiteLaxMode,
		Path:     "/",
		Secure:   true,
	}

	http.SetCookie(w, cookie)

	w.WriteHeader(http.StatusOK)
	w.Write(getJsonResponse(true, "logged in successfully", nil))
}
{{ end }}


{{- define "logout" }}
func api_logout_user(w http.ResponseWriter, _ *http.Request) {
	cookie := &http.Cookie{
		Name:    "access_token",
		Value:   "",
		Expires: time.Now(),
		Path:    "/",
	}
	http.SetCookie(w, cookie)

	w.Header().Set("Content-Type", "application/json")
	w.WriteHeader(http.StatusOK)
	w.Write(getJsonResponse(true, "logged out successfully", nil))
}
{{ end }}

{{ define "hashData" }}
	{{- $hashString := 0 -}}
	{{- $hashStringArr := 0 -}}

	{{- range $column := . -}}
		{{- if $column.Hash -}}
			{{- if HasSuffix $column.DataType "[]" -}}
				{{- $hashStringArr = increase $hashStringArr -}}
			{{- else -}}
				{{- $hashString = increase $hashString -}}
			{{- end -}}
		{{- end -}}
	{{- end -}}

	{{ if or $hashString $hashStringArr }}
		if err := hashData(
			{{- if gt $hashString 0 -}}
				[]*CustomNullString{
					{{- range $column := . -}}
						{{- if and $column.Hash (not (HasSuffix $column.DataType "[]")) -}}
							&item.Column_ {{- $column.ColumnName -}}
							{{- $hashString = decrease $hashString -}}
							{{- if $hashString -}} , {{- end -}}
						{{- end -}}
					{{- end -}}
				},
			{{- else -}}
				nil,
			{{- end -}}

			{{- if gt $hashStringArr 0 -}}
				[][]*CustomNullString{
					{{- range $column := . -}}
						{{- if and $column.Hash (HasSuffix $column.DataType "[]") -}}
							&item.Column_ {{- $column.ColumnName -}}
							{{- $hashStringArr = decrease $hashStringArr -}}
							{{- if $hashStringArr -}} , {{- end -}}
						{{- end -}}
					{{- end -}}
				},
			{{- else -}}
				nil,
			{{- end -}}
		); err != nil {
			message := fmt.Sprintf("error while hashing fields: %v", err)
			log.Print(message)
			w.WriteHeader(http.StatusBadRequest)
			w.Write(getJsonResponse(false, message, nil))
			return
		}
	{{ end }}

{{ end }}
